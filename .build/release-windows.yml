image: ubuntu/lts
sources:
  - https://git.sr.ht/~terrence/openfa
packages:
  - cmake
  - curl
  - g++
  - gcc
  - mingw-w64
  - python
  - zip
secrets:
  - 4b891bcd-b5fd-4bfb-a34b-1cdc2003ec51
tasks:
  - setup: |
      curl https://sh.rustup.rs -sSf | sh -s -- -y
      source $HOME/.cargo/env 
      rustup target add x86_64-pc-windows-gnu
      printf "[target.x86_64-pc-windows-gnu]\nlinker = \"/usr/bin/x86_64-w64-mingw32-gcc\"" > $HOME/.cargo/config
  - build: |
      cd openfa
      source $HOME/.cargo/env 
      cargo build --release --target x86_64-pc-windows-gnu -p picpack -p picdump -p pedump -p unlib
  - release: |
      cd openfa
      version=$(date +%Y.%m.%d-%H.%M.%S)
      relname="$version"-x86_64-windows-openfa-cli-tools
      mkdir $relname
      cp target/x86_64-pc-windows-gnu/release/picpack.exe $relname/
      cp target/x86_64-pc-windows-gnu/release/picdump.exe $relname/
      cp target/x86_64-pc-windows-gnu/release/pedump.exe $relname/
      cp target/x86_64-pc-windows-gnu/release/unlib.exe $relname/
      zip -9r "$relname".zip "$relname"/
      blob=$(printf '{"tag_name":"%s","target_commitish":"master","name":"%s","body":"Auto-release for %s","draft":false,"prerelease":false}' $relname $relname $version)
      set -e
      token=$(cat ~/.github_access_token)
      repo=https://api.github.com/repos/terrence2/openfa/releases?access_token="$token"
      release_id="$(curl --data "$blob" $repo | python -c "import sys, json; print json.load(sys.stdin)['id']")"
      assets=https://uploads.github.com/repos/terrence2/openfa/releases/"$release_id"/assets?name="$relname".zip"&"access_token="$token"
      curl --data-binary "$relname".zip -H "Content-Type: application/octet-stream" $assets
      set +e